<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Unidades Consumidoras</title>
  <link rel="stylesheet" href="assets/css/style.css">
</head>
<body>

<div class="container">

  <nav id="side-menu">
    <h2>⚡ Energia</h2>
    <ul>
      <li><a href="index.html">Dashboard</a></li>
      <li><a href="empresas.html">Empresas</a></li>
      <li><a href="lojas.html">Lojas</a></li>
      <li><a href="unidades.html">Unidades</a></li>
      <li><a href="faturas.html">Faturas</a></li>
      <li><a href="relatorios.html">Relatórios</a></li>
      <li><a href="configuracoes.html">Configurações</a></li>
    </ul>
  </nav>

  <main>
    <h2>Unidades Consumidoras</h2>

    <div class="card">
      <label>Loja</label>
      <select id="lojaUC"></select>

      <label>Número da UC</label>
      <input id="numeroUC" placeholder="Ex: 10026875126">

      <label>Distribuidora</label>
      <input id="distribuidora" placeholder="Ex: Equatorial">

      <button onclick="cadastrarUnidade()">Salvar unidade</button>
    </div>

    <div class="card">
      <h3>Unidades cadastradas</h3>
      <ul id="listaUnidades"></ul>
    </div>
  </main>

</div>

<!-- SUPABASE -->
<script src="assets/js/supabase.js"></script>

<!-- SCRIPT DA PÁGINA -->
<script>
async function carregarLojas() {
  const select = document.getElementById("lojaUC");
  select.innerHTML = "";

  const empresas = await listarEmpresas();
  for (const e of empresas) {
    const lojas = await listarLojas(e.id);
    lojas.forEach(l => {
      const opt = document.createElement("option");
      opt.value = l.id;
      opt.textContent = `${e.nome} - ${l.nome}`;
      select.appendChild(opt);
    });
  }

  if (select.value) {
    carregarUnidades(select.value);
  }
}

async function carregarUnidades(loja_id) {
  const lista = document.getElementById("listaUnidades");
  lista.innerHTML = "";

  const unidades = await listarUnidades(loja_id);
  unidades.forEach(u => {
    const li = document.createElement("li");
    li.textContent = `${u.uc} (${u.distribuidora || "sem distribuidora"})`;
    lista.appendChild(li);
  });
}

async function cadastrarUnidade() {
  const loja_id = document.getElementById("lojaUC").value;
  const uc = document.getElementById("numeroUC").value.trim();
  const distribuidora = document.getElementById("distribuidora").value.trim();

  if (!uc) {
    alert("Informe o número da UC");
    return;
  }

  await salvarUnidade(loja_id, uc, distribuidora);
  document.getElementById("numeroUC").value = "";
  document.getElementById("distribuidora").value = "";
  carregarUnidades(loja_id);
}

document.getElementById("lojaUC")
  .addEventListener("change", e => {
    carregarUnidades(e.target.value);
  });

carregarLojas();
</script>

</body>
</html>
