<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Faturas</title>
  <link rel="stylesheet" href="assets/css/style.css">
</head>
<body>

<div class="container">

  <nav id="side-menu">
    <h2>âš¡ Energia</h2>
    <ul>
      <li><a href="index.html">Dashboard</a></li>
      <li><a href="empresas.html">Empresas</a></li>
      <li><a href="lojas.html">Lojas</a></li>
      <li><a href="unidades.html">Unidades</a></li>
      <li><a href="faturas.html">Faturas</a></li>
      <li><a href="relatorios.html">RelatÃ³rios</a></li>
      <li><a href="configuracoes.html">ConfiguraÃ§Ãµes</a></li>
    </ul>
  </nav>

  <main>
    <h2>Faturas</h2>

    <!-- CADASTRO / IMPORTAÃ‡ÃƒO -->
    <div class="card">
      <label>Unidade Consumidora</label>
      <select id="unidadeSelect"></select>

      <label>Importar fatura (PDF)</label>
      <input type="file" id="pdfInput" accept="application/pdf">

      <hr>

      <label>MÃªs/Ano</label>
      <input id="mesAno" placeholder="2026-02">

      <label>Vencimento</label>
      <input type="date" id="vencimento">

      <label>Consumo (kWh)</label>
      <input type="number" id="consumo">

      <label>Valor (R$)</label>
      <input type="number" step="0.01" id="valor">

      <button onclick="cadastrarFatura()">Salvar fatura</button>
    </div>

    <!-- LISTAGEM -->
    <div class="card">
      <h3>Faturas cadastradas</h3>
      <ul id="listaFaturas"></ul>
    </div>
  </main>

</div>

<!-- SUPABASE -->
<script src="assets/js/supabase.js?v=6"></script>

<!-- SCRIPT PRINCIPAL -->
<script>
async function carregarUnidades() {
  const select = document.getElementById("unidadeSelect");
  select.innerHTML = "";

  const empresas = await listarEmpresas();
  for (const e of empresas) {
    const lojas = await listarLojas(e.id);
    for (const l of lojas) {
      const unidades = await listarUnidades(l.id);
      unidades.forEach(u => {
        const opt = document.createElement("option");
        opt.value = u.id;
        opt.textContent = `${e.nome} - ${l.nome} - UC ${u.uc}`;
        select.appendChild(opt);
      });
    }
  }

  if (select.value) {
    carregarFaturas(select.value);
  }
}

async function carregarFaturas(unidade_id) {
  const lista = document.getElementById("listaFaturas");
  lista.innerHTML = "";

  const faturas = await listarFaturas(unidade_id);
  faturas.forEach(f => {
    const li = document.createElement("li");
    li.textContent =
      `${f.mes_ano} | ${f.consumo_kwh} kWh | R$ ${f.valor}`;
    lista.appendChild(li);
  });
}

async function cadastrarFatura() {
  const unidade_id = document.getElementById("unidadeSelect").value;

  const dados = {
    unidade_id,
    mes_ano: document.getElementById("mesAno").value,
    vencimento: document.getElementById("vencimento").value,
    consumo_kwh: Number(document.getElementById("consumo").value),
    valor: Number(document.getElementById("valor").value)
  };

  if (!dados.mes_ano || !dados.vencimento) {
    alert("Preencha mÃªs/ano e vencimento");
    return;
  }

  await salvarFatura(dados);
  carregarFaturas(unidade_id);
}

document.getElementById("unidadeSelect")
  .addEventListener("change", e => {
    carregarFaturas(e.target.value);
  });

carregarUnidades();
</script>

<!-- PDF.JS (IMPORTAÃ‡ÃƒO AUTOMÃTICA) -->
<script type="module">
import * as pdfjsLib from "./assets/libs/pdf.mjs";

pdfjsLib.GlobalWorkerOptions.workerSrc =
  "./assets/libs/pdf.worker.mjs";

document.getElementById("pdfInput")
  .addEventListener("change", lerPDF);

async function lerPDF(event) {
  const file = event.target.files[0];
  if (!file) return;

  const buffer = await file.arrayBuffer();
  const pdf = await pdfjsLib.getDocument({ data: buffer }).promise;

  let texto = "";
  for (let i = 1; i <= pdf.numPages; i++) {
    const page = await pdf.getPage(i);
    const content = await page.getTextContent();
    texto += content.items.map(i => i.str).join(" ") + " ";
  }

  extrairDadosEquatorial(texto);
}
  
function extrairDadosEquatorial(texto) {
  texto = texto.replace(/\s+/g, " ").toUpperCase();

  // ================== MÃŠS / ANO ==================
  // Ex: CONTA MÃŠS DEZ/2025
  const mesMatch = texto.match(/CONTA MÃŠS\s+([A-Z]{3})\/(\d{4})/);

  if (mesMatch) {
    const meses = {
      JAN: "01", FEV: "02", MAR: "03", ABR: "04",
      MAI: "05", JUN: "06", JUL: "07", AGO: "08",
      SET: "09", OUT: "10", NOV: "11", DEZ: "12"
    };

    const mesNum = meses[mesMatch[1]];
    const ano = mesMatch[2];

    // formato 12/2025 (como vocÃª pediu)
    document.getElementById("mesAno").value = `${mesNum}/${ano}`;
  }

  // ================== VENCIMENTO ==================
  const vencMatch = texto.match(/VENCIMENTO\s+(\d{2}\/\d{2}\/\d{4})/);
  if (vencMatch) {
    const [d, m, a] = vencMatch[1].split("/");
    document.getElementById("vencimento").value = `${a}-${m}-${d}`;
  }

  // ================== CONSUMO ==================
  // Energia Ativa
  const ativaMatch = texto.match(/ENERGIA ATIVA.*?(\d+)\s*KWH/);
  const energiaAtiva = ativaMatch ? Number(ativaMatch[1]) : 0;

  // Energia GeraÃ§Ã£o (solar)
  const geracaoMatch = texto.match(/ENERGIA GERAÃ‡ÃƒO.*?(\d+)\s*KWH/);
  const energiaGeracao = geracaoMatch ? Number(geracaoMatch[1]) : 0;

  // ðŸ‘‰ consumo exibido = ENERGIA ATIVA (padrÃ£o correto)
  if (energiaAtiva) {
    document.getElementById("consumo").value = energiaAtiva;
  }

  // (log tÃ©cnico â€” depois podemos salvar no banco)
  if (energiaGeracao) {
    console.log("Energia solar (kWh):", energiaGeracao);
  }

  // ================== VALOR TOTAL ==================
  const totalMatch = texto.match(/TOTAL A PAGAR\s*R?\$?\s*([\d.,]+)/);
  if (totalMatch) {
    document.getElementById("valor").value =
      totalMatch[1].replace(".", "").replace(",", ".");
  }
}

</script>

</body>
</html>


