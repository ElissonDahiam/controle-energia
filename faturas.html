<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Faturas</title>
  <link rel="stylesheet" href="assets/css/style.css">
</head>
<body>

<div class="container">

  <nav id="side-menu">
    <h2>⚡ Energia</h2>
    <ul>
      <li><a href="index.html">Dashboard</a></li>
      <li><a href="empresas.html">Empresas</a></li>
      <li><a href="lojas.html">Lojas</a></li>
      <li><a href="unidades.html">Unidades</a></li>
      <li><a href="faturas.html">Faturas</a></li>
      <li><a href="relatorios.html">Relatórios</a></li>
      <li><a href="configuracoes.html">Configurações</a></li>
    </ul>
  </nav>

  <main>
    <h2>Faturas</h2>

    <div class="card">

      <label>Unidade Consumidora</label>
      <select id="unidadeSelect"></select>

      <label>Arquivar fatura (PDF)</label>
      <input type="file" id="pdfInput" accept="application/pdf">

      <hr>

      <label>Mês/Ano</label>
      <input id="mesAno" placeholder="12/2025">

      <label>Vencimento</label>
      <input type="date" id="vencimento">

      <label>Energia Ativa (kWh)</label>
      <input type="number" id="consumoAtivo">

      <label>Energia Geração (kWh)</label>
      <input type="number" id="energiaGeracao">

      <label>Consumo Total (kWh)</label>
      <input type="number" id="consumoTotal" readonly>

      <label>Valor (R$)</label>
      <input type="number" step="0.01" id="valor">

      <button id="btnSalvar">Salvar fatura</button>
    </div>

    <div class="card">
      <h3>Faturas cadastradas</h3>
      <ul id="listaFaturas"></ul>
    </div>
  </main>

</div>

<script src="assets/js/supabase.js?v=9"></script>

<script>
document.addEventListener("DOMContentLoaded", async () => {

  const unidadeSelect   = document.getElementById("unidadeSelect");
  const pdfInput        = document.getElementById("pdfInput");
  const mesAno          = document.getElementById("mesAno");
  const vencimento      = document.getElementById("vencimento");
  const consumoAtivo    = document.getElementById("consumoAtivo");
  const energiaGeracao  = document.getElementById("energiaGeracao");
  const consumoTotal    = document.getElementById("consumoTotal");
  const valor           = document.getElementById("valor");
  const listaFaturas    = document.getElementById("listaFaturas");
  const btnSalvar       = document.getElementById("btnSalvar");

  function calcularTotal() {
    consumoTotal.value =
      (Number(consumoAtivo.value) || 0) +
      (Number(energiaGeracao.value) || 0);
  }

  consumoAtivo.addEventListener("input", calcularTotal);
  energiaGeracao.addEventListener("input", calcularTotal);

  async function carregarUnidades() {
    unidadeSelect.innerHTML = "";

    const empresas = await listarEmpresas();
    for (const e of empresas) {
      const lojas = await listarLojas(e.id);
      for (const l of lojas) {
        const unidades = await listarUnidades(l.id);
        unidades.forEach(u => {
          const opt = document.createElement("option");
          opt.value = u.id;
          opt.textContent = `${e.nome} - ${l.nome} - UC ${u.uc}`;
          unidadeSelect.appendChild(opt);
        });
      }
    }

    if (unidadeSelect.value) carregarFaturas(unidadeSelect.value);
  }

  async function carregarFaturas(unidade_id) {
    listaFaturas.innerHTML = "";
    const faturas = await listarFaturas(unidade_id);

    faturas.forEach(f => {
      const li = document.createElement("li");
      li.textContent = `
        ${f.mes_ano} |
        Ativo: ${f.consumo_ativo_kwh} |
        Geração: ${f.energia_geracao_kwh} |
        Total: ${f.consumo_total_kwh} |
        R$ ${f.valor}
      `;
      listaFaturas.appendChild(li);
    });
  }

  async function salvarPDF(file) {
    const nome = `${Date.now()}-${file.name}`;
    const { error } = await supabase
      .storage
      .from("faturas-pdf")
      .upload(nome, file);

    if (error) throw error;
    return nome;
  }

  btnSalvar.addEventListener("click", async () => {
    try {
      let pdfPath = null;
      if (pdfInput.files[0]) {
        pdfPath = await salvarPDF(pdfInput.files[0]);
      }

      const dados = {
        unidade_id: unidadeSelect.value,
        mes_ano: mesAno.value,
        vencimento: vencimento.value || null,
        consumo_ativo_kwh: Number(consumoAtivo.value) || 0,
        energia_geracao_kwh: Number(energiaGeracao.value) || 0,
        consumo_total_kwh: Number(consumoTotal.value) || 0,
        valor: Number(valor.value) || 0,
        pdf_path: pdfPath
      };

      await salvarFatura(dados);
      carregarFaturas(dados.unidade_id);
      alert("Fatura salva com sucesso");

    } catch (err) {
      console.error(err);
      alert("Erro ao salvar fatura");
    }
  });

  unidadeSelect.addEventListener("change", e => {
    carregarFaturas(e.target.value);
  });

  carregarUnidades();
});
</script>

</body>
</html>
