<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Faturas</title>
  <link rel="stylesheet" href="assets/css/style.css">
</head>
<body>

<div class="container">

  <nav id="side-menu">
    <h2>⚡ Energia</h2>
    <ul>
      <li><a href="index.html">Dashboard</a></li>
      <li><a href="empresas.html">Empresas</a></li>
      <li><a href="lojas.html">Lojas</a></li>
      <li><a href="unidades.html">Unidades</a></li>
      <li><a href="faturas.html">Faturas</a></li>
      <li><a href="relatorios.html">Relatórios</a></li>
      <li><a href="configuracoes.html">Configurações</a></li>
    </ul>
  </nav>

  <main>
    <h2>Faturas</h2>

    <div class="card">
      <label>Unidade Consumidora</label>
      <select id="unidadeSelect"></select>

      <label>Importar fatura (PDF)</label>
      <input type="file" id="pdfInput" accept="application/pdf">

      <hr>

      <label>Mês/Ano</label>
      <input id="mesAno" placeholder="12/2025">

      <label>Vencimento</label>
      <input type="date" id="vencimento">

      <label>Consumo (kWh)</label>
      <input type="number" id="consumo">

      <label>Valor (R$)</label>
      <input type="number" step="0.01" id="valor">

      <button onclick="cadastrarFatura()">Salvar fatura</button>
    </div>

    <div class="card">
      <h3>Faturas cadastradas</h3>
      <ul id="listaFaturas"></ul>
    </div>
  </main>

</div>

<!-- SUPABASE -->
<script src="assets/js/supabase.js?v=8"></script>

<!-- PDF.JS UMD (ÚNICO E CORRETO) -->
<script src="assets/libs/pdf.min.js"></script>
<script>
  pdfjsLib.GlobalWorkerOptions.workerSrc =
    "assets/libs/pdf.worker.min.js";
</script>

<!-- PARSER -->
<script src="assets/js/pdf-import.js"></script>

<!-- SCRIPT DA PÁGINA -->
<script>
async function carregarUnidades() {
  unidadeSelect.innerHTML = "";

  const empresas = await listarEmpresas();
  for (const e of empresas) {
    const lojas = await listarLojas(e.id);
    for (const l of lojas) {
      const unidades = await listarUnidades(l.id);
      unidades.forEach(u => {
        const opt = document.createElement("option");
        opt.value = u.id;
        opt.textContent = `${e.nome} - ${l.nome} - UC ${u.uc}`;
        unidadeSelect.appendChild(opt);
      });
    }
  }

  if (unidadeSelect.value) carregarFaturas(unidadeSelect.value);
}

async function carregarFaturas(unidade_id) {
  listaFaturas.innerHTML = "";
  const faturas = await listarFaturas(unidade_id);

  faturas.forEach(f => {
    const li = document.createElement("li");
    li.textContent = `${f.mes_ano} | ${f.consumo_kwh} kWh | R$ ${f.valor}`;
    listaFaturas.appendChild(li);
  });
}

async function cadastrarFatura() {
  const dados = {
    unidade_id: unidadeSelect.value,
    mes_ano: mesAno.value,
    vencimento: vencimento.value,
    consumo_kwh: Number(consumo.value),
    valor: Number(valor.value)
  };

  if (!dados.mes_ano || !dados.vencimento) {
    alert("Preencha mês/ano e vencimento");
    return;
  }

  await salvarFatura(dados);
  carregarFaturas(dados.unidade_id);
}

unidadeSelect.addEventListener("change", e => {
  carregarFaturas(e.target.value);
});

pdfInput.addEventListener("change", async (e) => {
  const file = e.target.files[0];
  if (!file) return;

  const dados = await importarFaturaEquatorial(file);

  console.log("PDF importado:", dados);

  if (dados.mes_ano) mesAno.value = dados.mes_ano;
  if (dados.vencimento) vencimento.value = dados.vencimento;
  if (dados.consumo_kwh) consumo.value = dados.consumo_kwh;
  if (dados.valor) valor.value = dados.valor;
});

carregarUnidades();
</script>

</body>
</html>
